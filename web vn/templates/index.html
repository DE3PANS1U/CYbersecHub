<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Web Vulnerability Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- REMOVE Link to main theme styles -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"> -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        /* Restore original styles */
        :root {
            /* Restore these color overrides */
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --background-color: #1a1a2e; /* Dark blue background */
            --card-background-color: #2a2a3e; /* Slightly lighter card background */
            --text-color: #e0e0e0; /* Light text for dark background */
            --text-muted-color: #a0a0b0;
            --border-color: #40405a;
        }

        body {
            /* Restore original values */
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            margin-bottom: 25px;
            /* Restore original shadow */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            /* Restore original values */
            background-color: var(--card-background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .card-header {
             /* Restore original alpha */
             background-color: rgba(255, 255, 255, 0.05);
             border-bottom: 1px solid var(--border-color);
             padding: 1rem 1.25rem;
        }
         .card-header h5 {
             margin-bottom: 0;
             font-weight: 500;
             /* Restore original color */
             color: #f0f0f0;
         }
        .card-body {
             padding: 1.5rem;
        }

        h1, h2, h3, h4, h5, h6 {
             /* Restore original color */
             color: #f0f0f0;
        }

        /* Input Form */
        #scanForm label {
             /* Restore original color */
             color: var(--text-muted-color);
             margin-bottom: 0.5rem;
             font-weight: 500;
             /* remove opacity */
        }
         #scanForm input[type="url"] {
             /* Restore original alpha */
             background-color: rgba(255, 255, 255, 0.05);
             border: 1px solid var(--border-color);
             color: var(--text-color);
             border-radius: 6px;
             padding: 0.75rem 1rem;
         }
         #scanForm input[type="url"]::placeholder {
             /* Restore original color */
             color: var(--text-muted-color);
             /* remove opacity */
         }
         #scanForm input[type="url"]:focus {
             /* Restore original alpha */
             background-color: rgba(255, 255, 255, 0.1);
             border-color: var(--primary-color);
             /* Restore original shadow */
             box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
             color: var(--text-color);
         }
         #scanForm button[type="submit"] {
             background-color: var(--primary-color);
             border: none;
             padding: 0.75rem 1.5rem;
             border-radius: 6px;
             font-weight: 500;
             transition: background-color 0.2s ease;
             /* Restore original color assumption */
             color: #fff;
         }
         #scanForm button[type="submit"]:hover {
             /* Restore original hover */
             background-color: #0056b3;
         }


        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
            background-color: var(--card-background-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
         .loading .spinner-border {
             width: 3rem;
             height: 3rem;
             color: var(--primary-color);
         }
         .loading h4 {
             margin-top: 1.5rem;
             /* Restore original color */
             color: var(--text-muted-color);
             /* remove opacity */
         }

        /* Scan Progress */
         #scanProgress {
             margin-top: 2rem;
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
             gap: 10px;
         }
        .scan-step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 15px;
            /* Restore original alpha */
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }
        .scan-step span {
            font-size: 0.9em;
            font-weight: 500;
             /* Restore original color */
             color: var(--text-color);
        }
         .scan-step i {
             font-size: 1em;
             width: 18px; /* Ensure icons align */
             text-align: center;
         }
         .scan-step.success {
             /* Restore original colors */
             background-color: rgba(40, 167, 69, 0.1);
             border-color: rgba(40, 167, 69, 0.5);
         }
         .scan-step.success i {
             color: var(--success-color);
         }
         .scan-step.error {
             /* Restore original colors */
             background-color: rgba(220, 53, 69, 0.1);
             border-color: rgba(220, 53, 69, 0.5);
         }
         .scan-step.error i {
             color: var(--danger-color);
         }

        .scan-duration {
            text-align: center;
            padding: 15px;
            /* Restore original alpha */
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 20px;
             /* Restore original color */
            color: var(--text-muted-color);
            /* remove opacity */
            font-weight: 500;
        }

        /* Results Sections General */
        .scan-section {
            margin-bottom: 2rem;
             padding: 0; /* Remove padding, handled by card-body */
             background: transparent; /* Use card background */
             border-radius: 0;
             box-shadow: none;
             border: none;
         }
        .scan-section h4 {
             /* Restore original color */
             color: #f0f0f0;
             margin-bottom: 1rem; /* Reduced margin */
            display: flex;
            align-items: center;
             gap: 0.75rem;
             font-weight: 500;
             font-size: 1.2rem;
        }
        .scan-section h4 i {
             color: var(--primary-color);
             font-size: 1.1em;
         }

        /* Target Information */
        .target-info {
            /* Restore original gradient */
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: none;
        }
        .target-info h4 {
            color: white;
            margin-bottom: 1rem;
        }
        .target-info p {
            margin: 0.5rem 0;
            font-size: 1.1em;
        }
         .target-info p strong {
             font-weight: 500;
         }

        /* Security Headers / Issues */
        .headers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.25rem;
        }
        .header-item {
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            /* Restore original alpha */
            background: rgba(255, 255, 255, 0.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
         .header-item:hover {
             transform: translateY(-3px);
             box-shadow: 0 6px 12px rgba(0,0,0,0.15);
         }
        .header-item.missing {
            border-left: 4px solid var(--danger-color);
             /* Restore original colors */
            background: rgba(220, 53, 69, 0.1);
        }
        .header-item.present {
            border-left: 4px solid var(--success-color);
             /* Restore original colors */
            background: rgba(40, 167, 69, 0.1);
        }
         .header-item strong:first-child {
            font-weight: 500;
             /* Restore original color */
            color: #f0f0f0;
            display: block;
            margin-bottom: 0.75rem;
         }
        .header-details {
            margin-top: 0.5rem;
            font-size: 0.9rem;
             /* Restore original color */
            color: var(--text-muted-color);
            /* remove opacity */
        }
        .header-details p {
            margin: 0.35rem 0;
        }
         /* Restore other specific styles that might have been removed */
         .header-details strong {
             color: var(--text-color);
             font-weight: 500;
         }

        /* Issues List */
        .issues-list {
            display: grid;
            gap: 1rem;
        }
        .issue-item {
            padding: 1rem 1.25rem;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            position: relative;
            border-left-width: 4px;
            transition: background-color 0.2s ease;
        }
         .issue-item:hover {
             background: rgba(255, 255, 255, 0.07);
         }
        .issue-item.high {
            border-left-color: var(--danger-color);
            background: rgba(220, 53, 69, 0.1);
        }
        .issue-item.medium {
            border-left-color: var(--warning-color);
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107; /* Medium severity text */
        }
        .issue-item.low {
            border-left-color: var(--info-color);
            background: rgba(23, 162, 184, 0.1);
            color: #17a2b8; /* Low severity text */
        }
        .issue-item strong {
            font-weight: 500;
            color: #f0f0f0;
            display: block;
            margin-bottom: 0.25rem;
        }
         .issue-item p {
             margin-bottom: 0;
             font-size: 0.95em;
        }

        .severity-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: white;
        }
        .issue-item.high .severity-badge {
            background: var(--danger-color);
        }
        .issue-item.medium .severity-badge {
            background: var(--warning-color);
            color: var(--dark-color);
        }
        .issue-item.low .severity-badge {
            background: var(--info-color);
        }

        /* SSL/TLS Info */
        .ssl-info {
            background: rgba(255, 255, 255, 0.03);
            padding: 1.25rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
         .ssl-info p {
             margin-bottom: 0.75rem;
             font-size: 0.95em;
         }
         .ssl-info strong {
             font-weight: 500;
             color: #f0f0f0;
             min-width: 150px;
             display: inline-block;
         }
        .cipher-issues {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
         .cipher-issues h5 {
             font-size: 1rem;
             font-weight: 500;
             color: var(--warning-color);
             margin-bottom: 1rem;
         }

        /* Ports */
        .ports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
        }
        .port-item {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            display: block; /* Reset flex */
            gap: 0;
            margin-bottom: 0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
         .port-item:hover {
             transform: translateY(-3px);
             box-shadow: 0 6px 12px rgba(0,0,0,0.15);
         }
         .port-item p {
             margin-bottom: 0.5rem;
             font-size: 0.9em;
         }
         .port-item strong {
             font-weight: 700;
             color: #f0f0f0;
             font-size: 1.1em;
             display: block;
             margin-bottom: 0.5rem;
         }
         .port-item .text-muted {
             color: var(--text-muted-color) !important;
         }
        .security-note {
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: var(--warning-color);
        }
         .security-note i {
             margin-right: 0.5rem;
         }

        /* DNS */
        .dns-records {
            display: grid;
            gap: 1rem;
        }
        .dns-record-type {
            background: rgba(255, 255, 255, 0.03);
            padding: 1.25rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .dns-record-type strong {
            font-weight: 500;
            color: #f0f0f0;
            display: block;
            margin-bottom: 0.75rem;
        }
        .dns-record-type ul {
            margin: 0;
            padding-left: 0;
            list-style: none;
        }
         .dns-record-type li {
             padding: 0.3rem 0;
             border-bottom: 1px solid rgba(255, 255, 255, 0.05);
             font-size: 0.95em;
         }
         .dns-record-type li:last-child {
             border-bottom: none;
         }

        /* WHOIS */
        .whois-info {
            background: rgba(255, 255, 255, 0.03);
            padding: 1.25rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .whois-info p {
            margin-bottom: 0.75rem;
            font-size: 0.95em;
        }
        .whois-label {
            font-weight: 500;
            color: var(--text-muted-color);
            min-width: 130px;
            display: inline-block;
        }
        .whois-value {
            color: var(--text-color);
        }
        .whois-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 5px;
            font-weight: 500;
            text-transform: capitalize;
        }
        .status-active, .status-ok, .status-clientupdateprohibited, .status-clienttransferprohibited, .status-clientdeleteprohibited {
            background-color: var(--success-color);
            color: white;
        }
        .status-expired, .status-pendingdelete {
            background-color: var(--danger-color);
            color: white;
        }
        .status-pending, .status-redemptionperiod, .status-clienthold {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }

        .raw-whois-container {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 1.5rem;
            max-height: 400px; /* Adjusted height */
            overflow-y: auto;
        }
        .raw-whois-header {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .raw-whois-title {
            font-weight: 500;
            color: #f0f0f0;
        }
        .raw-whois-toggle {
            cursor: pointer;
            color: var(--text-muted-color);
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
            background: rgba(255, 255, 255, 0.1);
            border: none;
        }
        .raw-whois-toggle:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: #f0f0f0;
        }
        .raw-whois-data {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            line-height: 1.6;
            padding: 1.5rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-muted-color);
        }
        .raw-whois-data pre {
            margin: 0;
            color: inherit;
            background: none;
            padding: 0;
            border: none;
        }

        /* Vulnerability & SQL Injection */
        .vulnerabilities, .sql-details {
            display: grid;
            gap: 1rem;
        }
         .vulnerability-item /* Merged with issue-item styles */
         {
            /* Uses .issue-item styles defined earlier */
         }
         .vulnerability-item pre code {
             display: block;
             margin-top: 0.75rem;
             padding: 0.75rem;
             background: rgba(0, 0, 0, 0.3);
             border-radius: 4px;
             font-size: 0.85em;
             color: #f0f0f0;
             max-height: 100px;
             overflow-y: auto;
             white-space: pre-wrap;
             word-break: break-all;
         }

        .sql-injection-results {
            background: transparent; /* Use card background */
            padding: 0; /* Handled by card body */
            border-radius: 0;
        }
        .sql-vulnerability {
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            background-color: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: #f8d7da;
        }
        .sql-safe {
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            background-color: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.5);
            color: #d4edda;
        }
         .sql-vulnerability p, .sql-safe p {
             margin-bottom: 0.5rem;
         }
         .sql-vulnerability strong, .sql-safe strong {
             font-weight: 500;
             color: #f0f0f0;
        }

        .sql-details {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
         .sql-details h5 {
             font-size: 1rem;
             font-weight: 500;
             color: var(--text-muted-color);
             margin-bottom: 1rem;
         }
        .sql-detail-item {
            margin-bottom: 0.75rem;
            padding: 0.75rem 1rem;
            border-left: 3px solid var(--secondary-color);
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
            font-size: 0.9em;
        }
        .sql-detail-type {
            font-weight: 500;
            color: #f0f0f0;
            text-transform: capitalize;
        }
        .sql-detail-payload {
            font-family: 'Courier New', Courier, monospace;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 3px;
            color: #f0f0f0;
            word-break: break-all;
        }
         .sql-detail-item strong {
             color: var(--text-muted-color);
             font-weight: 400;
         }

        /* Alert Box */
        .alert-danger {
             background-color: #dc3545;
             color: white;
             border: none;
             border-radius: 6px;
        }
         .alert-danger .alert-heading {
             color: white;
         }

        /* General Helpers */
        .text-success { color: var(--success-color) !important; }
        .text-danger { color: var(--danger-color) !important; }
        .text-warning { color: var(--warning-color) !important; }
        .text-info { color: var(--info-color) !important; }
        .text-muted { color: var(--text-muted-color) !important; }

        /* ... other existing styles ... */
    </style>
</head>
<body>
    <!-- REMOVE Theme Toggle Button -->
    <!-- <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">🌓</button> -->

    <div class="container">
        <!-- Add Back to Home Button -->
        <a href="http://127.0.0.1:5500" class="btn btn-outline-secondary mb-3"><i class="fas fa-arrow-left"></i> Back to CyberSec Hub</a>

        <h1 class="text-center mb-4">Enhanced Web Vulnerability Scanner</h1>
        
        <div class="card">
            <div class="card-body">
                <form id="scanForm">
                    <div class="mb-3">
                        <label for="urlInput" class="form-label">Target URL</label>
                        <input type="url" class="form-control" id="urlInput" required placeholder="https://example.com">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Select Scans to Perform:</label>
                        <div class="row">
                            <!-- Network/Infra Scans -->
                            <div class="col-md-6 col-lg-4 mb-2">
                                <div class="form-check form-switch form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="headers" id="scanHeaders" checked>
                                    <label class="form-check-label" for="scanHeaders"><i class="fas fa-shield-alt text-info"></i> Security Headers</label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4 mb-2">
                                <div class="form-check form-switch form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="ssl" id="scanSsl" checked>
                                    <label class="form-check-label" for="scanSsl"><i class="fas fa-lock text-success"></i> SSL/TLS</label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4 mb-2">
                                <div class="form-check form-switch form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="dns" id="scanDns" checked>
                                    <label class="form-check-label" for="scanDns"><i class="fas fa-server text-secondary"></i> DNS Info</label>
                                </div>
                            </div>
                             <div class="col-md-6 col-lg-4 mb-2">
                                <div class="form-check form-switch form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="whois" id="scanWhois" checked>
                                    <label class="form-check-label" for="scanWhois"><i class="fas fa-info-circle text-secondary"></i> WHOIS Info</label>
                                </div>
                            </div>
                             <div class="col-md-6 col-lg-4 mb-2">
                                <div class="form-check form-switch form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="discovery" id="scanDiscovery" checked>
                                    <label class="form-check-label" for="scanDiscovery"><i class="fas fa-file-alt text-secondary"></i> Discovery Files</label>
                                </div>
                            </div>
                             <!-- Application Scans -->
                             <div class="col-md-6 col-lg-4 mb-2">
                                <div class="form-check form-switch form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="vuln" id="scanVuln" checked>
                                    <label class="form-check-label" for="scanVuln"><i class="fas fa-bug text-warning"></i> Page Analysis</label>
                                </div>
                            </div>
                             <div class="col-md-6 col-lg-4 mb-2">
                                <div class="form-check form-switch form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="csrf" id="scanCsrf" checked>
                                    <label class="form-check-label" for="scanCsrf"><i class="fas fa-shield-virus text-warning"></i> CSRF Check</label>
                                </div>
                            </div>
                             <div class="col-md-6 col-lg-4 mb-2">
                                <div class="form-check form-switch form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="sql" id="scanSql" checked>
                                    <label class="form-check-label" for="scanSql"><i class="fas fa-database text-danger"></i> SQL Injection</label>
                                </div>
                            </div>
                             <div class="col-md-6 col-lg-4 mb-2">
                                <div class="form-check form-switch form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="xss" id="scanXss" checked>
                                    <label class="form-check-label" for="scanXss"><i class="fas fa-code text-danger"></i> XSS Scan</label>
                                </div>
                            </div>
                        </div>
                         <div class="form-check mt-2">
                             <input class="form-check-input" type="checkbox" id="selectAllScans" checked>
                             <label class="form-check-label" for="selectAllScans">Select/Deselect All</label>
                         </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search"></i> Start Scan</button>
                </form>
            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4 class="mt-3">Scanning target... Please wait.</h4>
            
            <div id="scanProgress" class="mt-4">
                <div class="scan-step" data-step="Security Headers">
                    <i class="fas fa-shield-alt"></i> <!-- Updated Icon -->
                    <span>Security Headers</span>
                </div>
                <div class="scan-step" data-step="SSL/TLS">
                    <i class="fas fa-lock"></i> <!-- Updated Icon -->
                    <span>SSL/TLS</span>
                </div>
                <div class="scan-step" data-step="Port Scan">
                    <i class="fas fa-network-wired"></i> <!-- Updated Icon -->
                    <span>Port Scan</span>
                </div>
                <div class="scan-step" data-step="DNS Information">
                    <i class="fas fa-server"></i> <!-- Updated Icon -->
                    <span>DNS Information</span>
                </div>
                <div class="scan-step" data-step="WHOIS Information">
                    <i class="fas fa-info-circle"></i> <!-- Updated Icon -->
                    <span>WHOIS Information</span>
                </div>
                <div class="scan-step" data-step="Vulnerability Analysis">
                    <i class="fas fa-bug"></i> <!-- Updated Icon -->
                    <span>Vulnerability Analysis</span>
                </div>
                 <div class="scan-step" data-step="SQL Injection">
                    <i class="fas fa-database"></i> <!-- Added Icon -->
                    <span>SQL Injection</span>
            </div>
                 <div class="scan-step" data-step="XSS">
                    <i class="fas fa-code"></i> <!-- Added Icon -->
                    <span>XSS Scan</span>
        </div>
                 <div class="scan-step" data-step="Discovery Files">
                    <i class="fas fa-file-alt"></i> <!-- Added Icon -->
                    <span>Discovery Files</span>
                </div>
            </div>

            <div id="scanDuration" class="scan-duration"></div>
            </div>

        <div id="scanResults" style="display: none;">
            <!-- Target Info Card -->
            <div class="target-info card">
                <div class="card-body">
                     <h4><i class="fas fa-bullseye"></i> Target Information</h4>
                     <p><strong>URL:</strong> <span id="targetUrlResult"></span></p>
                     <p><strong>Scan Time:</strong> <span id="scanTimestampResult"></span></p>
                </div>
            </div>

            <!-- Results Cards (dynamically populated) -->

        </div>

        <!-- Export Button (hidden initially) -->
        <div id="exportSection" class="text-center mt-4" style="display: none;">
             <button id="exportPdfButton" class="btn btn-secondary"><i class="fas fa-file-pdf"></i> Export Results as PDF</button>
         </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <!-- REMOVE Link to main theme script -->
    <!-- <script src="{{ url_for('static', filename='script.js') }}"></script> -->
    <script>
        let currentScanResults = {}; // Store results globally for export

        document.getElementById('scanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const url = document.getElementById('urlInput').value;
            const loadingIndicator = document.getElementById('loadingIndicator');
            const scanResultsDiv = document.getElementById('scanResults');
            const scanProgress = document.getElementById('scanProgress');
            const scanDuration = document.getElementById('scanDuration');
            const exportSection = document.getElementById('exportSection'); // Get export section
            const exportButton = document.getElementById('exportPdfButton'); // Get export button
            const selectedCategories = Array.from(document.querySelectorAll('#scanForm input[type=checkbox]:checked:not(#selectAllScans)')).map(cb => cb.value);
            
            // --- Validation ---
            if (!url) {
                alert('Please enter a target URL.'); return;
            }
            if (selectedCategories.length === 0) {
                 alert('Please select at least one scan type to perform.'); return;
            }
            // --- End Validation ---
            
            // Remove any existing error messages
            const existingError = document.querySelector('.alert-danger');
            if (existingError) {
                existingError.remove();
            }
            
            // Clear previous results and reset target info
            scanResultsDiv.innerHTML = ''; // Clear dynamic cards
            scanResultsDiv.style.display = 'none'; // Hide results area initially
            exportSection.style.display = 'none'; // Hide export button
            currentScanResults = {}; // Clear previous results data
            const targetInfoCard = document.querySelector('.target-info.card');
            if (targetInfoCard) {
                targetInfoCard.style.display = 'none'; // Hide target info card
            }

            // Show loading indicator and configure/show only selected progress steps
            loadingIndicator.style.display = 'block';
            scanProgress.innerHTML = ''; // Clear previous steps
            selectedCategories.forEach(category => {
                const stepDiv = createProgressStep(category); // Create step dynamically
                if (stepDiv) {
                    scanProgress.appendChild(stepDiv);
                }
            });
            scanDuration.textContent = '';
            
            // --- START reverted fetch logic ---
            try {
                const startTime = new Date();
                const response = await fetch('/scan', { // Original fetch
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url, categories: selectedCategories }) 
                });
                
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    throw new Error('Invalid JSON response from server');
                }
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid data format from server');
                }
                
                // Update scan duration
                const endTime = new Date();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                scanDuration.textContent = `Scan completed in ${duration} seconds`;
                
                // Update progress indicators (all at once after completion)
                document.querySelectorAll('.scan-step').forEach(step => {
                    const categoryKey = step.getAttribute('data-category'); 
                    const icon = step.querySelector('i');
                    if (icon) {  // Add null check
                        const baseIconClass = icon.className.split(' ')[0] + ' ' + icon.className.split(' ')[1]; // Keep base icon
                        const status = getStepStatus(data, categoryKey); // Use the data from the single response
                        
                        icon.className = getStatusIcon(status, baseIconClass);
                        step.classList.add(status.toLowerCase());
                    }
                });
                
                // Store results for export
                currentScanResults = data;

                // Display results
                displayResults(data);
                scanResultsDiv.style.display = 'block'; // Show results area
                exportSection.style.display = 'block'; // Show export button
                
                // Update and show target info card
                if (targetInfoCard) {
                    document.getElementById('targetUrlResult').textContent = data.target_url || 'N/A';
                    document.getElementById('scanTimestampResult').textContent = data.timestamp || 'N/A';
                    targetInfoCard.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Scan Error:', error);
                // Display error alert
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-3';
                errorDiv.setAttribute('role', 'alert');
                errorDiv.innerHTML = `
                    <h4 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Scan Error</h4>
                    <p>${escapeHtml(error.message)}</p>
                    <hr>
                    <p class="mb-0">Please check the URL and network connection. If the problem persists, check the server logs.</p>
                `;
                 // Insert error before the loading indicator or results
                 loadingIndicator.parentNode.insertBefore(errorDiv, loadingIndicator);
            } finally {
                loadingIndicator.style.display = 'none';
            }
            // --- END reverted fetch logic ---
        });
        
        // --- Export PDF Button Logic ---
        document.getElementById('exportPdfButton').addEventListener('click', async function() {
            if (!currentScanResults || Object.keys(currentScanResults).length === 0) {
                alert('No scan data available to export.');
                return;
            }

            const button = this;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';

            try {
                const response = await fetch('/export_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentScanResults)
                });

                if (!response.ok) {
                     // Try to get error message from JSON response
                     let errorMsg = `HTTP error ${response.status}`;
                     try {
                         const errorData = await response.json();
                         errorMsg = errorData.error || errorMsg;
                     } catch (e) { /* Ignore if response is not JSON */ }
                    throw new Error(`PDF generation failed: ${errorMsg}`);
                }

                // Trigger download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                // Extract filename from Content-Disposition header if possible
                const disposition = response.headers.get('content-disposition');
                let filename = 'scan_report.pdf';
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) { 
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

            } catch (error) {
                console.error('Export PDF Error:', error);
                alert(`Error generating PDF: ${error.message}`);
            } finally {
                 button.disabled = false;
                 button.innerHTML = '<i class="fas fa-file-pdf"></i> Export Results as PDF';
            }
        });
        // --- End Export Logic ---
        
        // --- Helper function to create progress steps ---
        function createProgressStep(category) {
            const categoryMap = {
                'headers': { name: 'Security Headers', icon: 'fas fa-shield-alt' },
                'ssl': { name: 'SSL/TLS', icon: 'fas fa-lock' },
                'ports': { name: 'Port Scan', icon: 'fas fa-network-wired' },
                'dns': { name: 'DNS Information', icon: 'fas fa-server' },
                'whois': { name: 'WHOIS Information', icon: 'fas fa-info-circle' },
                'vuln': { name: 'Page Analysis', icon: 'fas fa-bug' },
                'sql': { name: 'SQL Injection', icon: 'fas fa-database' },
                'xss': { name: 'XSS Scan', icon: 'fas fa-code' },
                'discovery': { name: 'Discovery Files', icon: 'fas fa-file-alt' },
                'csrf': { name: 'CSRF Check', icon: 'fas fa-shield-virus' }
            };
            const details = categoryMap[category];
            if (!details) return null;

            const stepDiv = document.createElement('div');
            stepDiv.className = 'scan-step';
            stepDiv.setAttribute('data-category', category); // Store category key
            stepDiv.innerHTML = `<i class="${details.icon} fa-spin"></i><span>${details.name}</span>`;
            return stepDiv;
        }
        // --- End Helper ---
        
        function getStepStatus(data, stepName) {
            if (!data) return 'Error';
            
            switch(stepName) {
                case 'headers':
                    return data.header_scan && data.header_scan.status === 'success' ? 'Success' : 'Error';
                case 'ssl':
                     // Reverted logic for step status - check if scan exists in response
                     return data.ssl_scan ? (data.ssl_scan.status === 'success' ? 'Success' : 'Error') : 'Skipped';
                case 'ports':
                    return data.port_scan ? (data.port_scan.status === 'success' ? 'Success' : 'Error') : 'Skipped';
                case 'dns':
                    return data.dns_info ? (data.dns_info.status === 'success' ? 'Success' : 'Error') : 'Skipped';
                case 'whois':
                    return data.whois_info ? (data.whois_info.status === 'success' ? 'Success' : 'Error') : 'Skipped';
                case 'vuln': 
                    return data.vulnerability_scan ? (data.vulnerability_scan.status === 'success' ? 'Success' : 'Error') : 'Skipped';
                case 'csrf': 
                    return data.csrf_scan ? (data.csrf_scan.status === 'success' ? 'Success' : 'Error') : 'Skipped';
                case 'sql':
                    return data.sql_injection_scan ? (data.sql_injection_scan.status === 'success' ? 'Success' : 'Error') : 'Skipped';
                case 'xss': 
                    return data.xss_scan ? (data.xss_scan.status === 'success' ? 'Success' : 'Error') : 'Skipped';
                case 'discovery':
                    // For discovery, consider not_found as success for the step indicator
                    return data.discovery_scan ? 
                               (data.discovery_scan.robots.status !== 'error' && data.discovery_scan.sitemap.status !== 'error' && data.discovery_scan.sitemap.status !== 'parse_error' ? 'Success' : 'Error') 
                               : 'Skipped';
                default:
                    return 'Skipped'; // Default to skipped if category not found
            }
        }
        
        function getStatusIcon(status, baseIconClass) {
             // Remove fa-spin before adding final icon
             const cleanBaseIcon = baseIconClass.replace(' fa-spin', '');
            switch(status) {
                case 'Success':
                    return `${cleanBaseIcon} text-success`;
                case 'Error':
                    return `${cleanBaseIcon} text-danger`; 
                case 'Skipped': // Added case for skipped steps
                     return `${cleanBaseIcon} text-muted`; // Show dimmed icon
                default:
                    return `${cleanBaseIcon}`; // Should not happen
            }
        }

        // Function to create a results card
        function createResultCard(title, iconClass) {
             const card = document.createElement('div');
             card.className = 'card scan-section'; // Add scan-section for consistency if needed
             const cardHeader = document.createElement('div');
             cardHeader.className = 'card-header';
             cardHeader.innerHTML = `<h5 class="mb-0"><i class="${iconClass}"></i> ${title}</h5>`;
             const cardBody = document.createElement('div');
             cardBody.className = 'card-body';
             card.appendChild(cardHeader);
             card.appendChild(cardBody);
             return { card, cardBody };
        }
        
        function displayResults(data) {
            const scanResultsDiv = document.getElementById('scanResults');
            scanResultsDiv.innerHTML = ''; // Clear previous dynamic results cards

            // --- Security Headers --- 
            if (data.header_scan) {
                const { card, cardBody } = createResultCard('Security Headers', 'fas fa-shield-alt');
                if (data.header_scan.status === 'success' && data.header_scan.headers) {
                     cardBody.innerHTML = `
                    <div class="headers-grid">
                        ${Object.entries(data.header_scan.headers).map(([header, info]) => `
                            <div class="header-item ${info.value === 'Not Found' ? 'missing' : 'present'}">
                                    <strong>${escapeHtml(header)}:</strong>
                                <div class="header-details">
                                        <p><strong>Value:</strong> ${info.value === 'Not Found' ? '<span class="text-danger">Not Found</span>' : escapeHtml(info.value)}</p>
                                        <p><small><strong>Recommended:</strong> ${escapeHtml(info.recommended)}</small></p>
                                        <p><small><strong>Description:</strong> ${escapeHtml(info.description)}</small></p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                } else {
                     cardBody.innerHTML = `<p class="text-danger">Error: ${escapeHtml(data.header_scan.message || 'Could not fetch headers.')}</p>`;
                }
                scanResultsDiv.appendChild(card);
            }

            // --- Header Security Issues --- 
            if (data.header_scan && data.header_scan.security_issues && data.header_scan.security_issues.length > 0) {
                 const { card, cardBody } = createResultCard('Header Security Issues', 'fas fa-exclamation-triangle text-warning');
                 cardBody.innerHTML = `
                    <div class="issues-list">
                        ${data.header_scan.security_issues.map(issue => `
                            <div class="issue-item ${issue.severity.toLowerCase()}">
                                 <span class="severity-badge">${escapeHtml(issue.severity)}</span>
                                 <strong>${escapeHtml(issue.header)}:</strong>
                                 <p>${escapeHtml(issue.issue)}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                 scanResultsDiv.appendChild(card);
             }

            // --- SSL/TLS Information --- 
            if (data.ssl_scan) {
                 const { card, cardBody } = createResultCard('SSL/TLS Information', 'fas fa-lock');
                 if (data.ssl_scan.status === 'success') {
                     let expiryClass = '';
                     if (data.ssl_scan.days_until_expiry !== undefined) {
                         if (data.ssl_scan.days_until_expiry < 0) expiryClass = 'text-danger';
                         else if (data.ssl_scan.days_until_expiry < 30) expiryClass = 'text-warning';
                         else expiryClass = 'text-success';
                     }
                    cardBody.innerHTML = `
                    <div class="ssl-info">
                            <p><strong>Protocol Version:</strong> ${escapeHtml(data.ssl_scan.protocol_version || 'N/A')}</p>
                            <p><strong>Days Until Expiry:</strong> <span class="${expiryClass}">${data.ssl_scan.days_until_expiry !== undefined ? data.ssl_scan.days_until_expiry : 'N/A'}</span></p>
                            <p><strong>Cipher Suite:</strong> ${data.ssl_scan.cipher_suite ? `${escapeHtml(data.ssl_scan.cipher_suite.name)} (${escapeHtml(data.ssl_scan.cipher_suite.bits)} bits)` : 'N/A'}</p>
                            ${data.ssl_scan.cipher_issues && data.ssl_scan.cipher_issues.length > 0 ? `
                            <div class="cipher-issues">
                                    <h5><i class="fas fa-exclamation-circle text-warning"></i> Cipher Issues Found:</h5>
                                ${data.ssl_scan.cipher_issues.map(issue => `
                                    <div class="issue-item ${issue.severity.toLowerCase()}">
                                            <span class="severity-badge">${escapeHtml(issue.severity)}</span>
                                            <p>${escapeHtml(issue.issue)} (Cipher: ${escapeHtml(issue.cipher)})</p>
                                    </div>
                                `).join('')}
                            </div>
                            ` : '<p><i class="fas fa-check-circle text-success"></i> No significant cipher issues found.</p>'}
                    </div>
                `;
                } else {
                    cardBody.innerHTML = `<p class="text-muted"><i class="fas fa-info-circle"></i> ${escapeHtml(data.ssl_scan.message || 'Could not retrieve SSL/TLS info (e.g., HTTP site or connection failed).')}</p>`;
                }
                 scanResultsDiv.appendChild(card);
            }

            // --- Port Scan Results --- 
            if (data.port_scan) {
                const { card, cardBody } = createResultCard('Open Ports', 'fas fa-network-wired');
                 if(data.port_scan.status === 'success') {
                     let portsContent = `<p class="text-muted"><small>Scan Time: ${escapeHtml(data.port_scan.scan_time || 'N/A')} seconds</small></p>`;
                     if(data.port_scan.open_ports && data.port_scan.open_ports.length > 0) {
                        portsContent += `<div class="ports-grid">
                        ${data.port_scan.open_ports.map(port => `
                            <div class="port-item">
                                    <p><strong>Port ${escapeHtml(port.port)}/${escapeHtml(port.protocol)} (${escapeHtml(port.state)})</strong></p>
                                    <p><span class="text-muted">Service:</span> ${escapeHtml(port.service || 'unknown')}</p>
                                    <p><span class="text-muted">Version:</span> ${escapeHtml(port.version || 'unknown')} ${escapeHtml(port.product || '')}</p>
                                    ${port.security_note ? `<p class="security-note"><i class="fas fa-exclamation-triangle"></i> ${escapeHtml(port.security_note)}</p>` : ''}
                            </div>
                        `).join('')}
                        </div>`;
                     } else {
                         portsContent += `<p><i class="fas fa-check-circle text-success"></i> No common ports found open.</p>`;
                     }
                     cardBody.innerHTML = portsContent;
                 } else {
                     cardBody.innerHTML = `<p class="text-danger">Error: ${escapeHtml(data.port_scan.message || 'Could not perform port scan.')}</p>`;
                 }
                 scanResultsDiv.appendChild(card);
            }

            // --- DNS Information --- 
            if (data.dns_info) {
                 const { card, cardBody } = createResultCard('DNS Information', 'fas fa-server');
                 if (data.dns_info.status === 'success') {
                     let dnsContent = `<div class="dns-records">
                        ${Object.entries(data.dns_info.records).filter(([type, records]) => records && records.length > 0 && !records[0].startsWith('Error:')).map(([type, records]) => `
                            <div class="dns-record-type">
                                <strong>${escapeHtml(type)} Records:</strong>
                                <ul>
                                    ${records.map(record => `<li>${escapeHtml(record)}</li>`).join('')}
                                </ul>
                            </div>
                        `).join('')}
                     </div>`;
                     // Add errors separately
                     const dnsErrors = Object.entries(data.dns_info.records)
                                            .filter(([type, records]) => records && records.length > 0 && records[0].startsWith('Error:'))
                                            .map(([type, records]) => `<p class="text-warning"><small><strong>${escapeHtml(type)} Error:</strong> ${escapeHtml(records[0])}</small></p>`);
                     if (dnsErrors.length > 0) {
                         dnsContent += `<div class="mt-3"><h5>DNS Lookup Errors:</h5>${dnsErrors.join('')}</div>`;
                     }
                     if(Object.values(data.dns_info.records).every(r => !r || r.length === 0 || r[0].startsWith('Error:'))) {
                         dnsContent += `<p><i class="fas fa-info-circle"></i> No standard DNS records found.</p>`;
                     }
                     cardBody.innerHTML = dnsContent;
                 } else {
                     cardBody.innerHTML = `<p class="text-danger">Error: ${escapeHtml(data.dns_info.message || 'Could not retrieve DNS information.')}</p>`;
                 }
                 scanResultsDiv.appendChild(card);
            }

            // --- WHOIS Information --- 
            if (data.whois_info) {
                 const { card, cardBody } = createResultCard('WHOIS Information', 'fas fa-info-circle');
                 if (data.whois_info.status === 'success') {
                    const whoisData = data.whois_info.data;
                    cardBody.innerHTML = `<div class="whois-info">
                        <p><span class="whois-label">Registrar:</span> <span class="whois-value">${escapeHtml(whoisData.registrar || 'N/A')}</span></p>
                        <p><span class="whois-label">Creation Date:</span> <span class="whois-value">${escapeHtml(whoisData.creation_date || 'N/A')}</span></p>
                        <p><span class="whois-label">Expiration Date:</span> <span class="whois-value">${escapeHtml(whoisData.expiration_date || 'N/A')}</span></p>
                        <p><span class="whois-label">Updated Date:</span> <span class="whois-value">${escapeHtml(whoisData.updated_date || 'N/A')}</span></p>
                        <p><span class="whois-label">Name Servers:</span> <span class="whois-value">${whoisData.name_servers && whoisData.name_servers.length > 0 ? escapeHtml(whoisData.name_servers.join(', ')) : 'N/A'}</span></p>
                        <p><span class="whois-label">Status:</span> ${whoisData.status && whoisData.status.length > 0 ? whoisData.status.map(s => `<span class="whois-status status-${escapeHtml(s.split(' ')[0].toLowerCase())}">${escapeHtml(s)}</span>`).join(' ') : 'N/A'}</p>
                        <p><span class="whois-label">Organization:</span> <span class="whois-value">${escapeHtml(whoisData.org || 'N/A')}</span></p>
                        <p><span class="whois-label">Country:</span> <span class="whois-value">${escapeHtml(whoisData.country || 'N/A')}</span></p>
                    </div>`;
                     if (data.whois_info.raw_text) {
                        cardBody.innerHTML += `
                            <div class="raw-whois-container mt-3">
                                <div class="raw-whois-header">
                                    <span class="raw-whois-title">Raw WHOIS Data</span>
                                    <button class="raw-whois-toggle btn btn-sm btn-outline-secondary" onclick="toggleRawWhois(this)">
                                        <i class="fas fa-chevron-down"></i> Show/Hide
                                    </button>
                                </div>
                                <div class="raw-whois-data" style="display: none;">
                                    <pre>${escapeHtml(data.whois_info.raw_text)}</pre>
                                </div>
                    </div>
                `;
                    }
                 } else {
                     cardBody.innerHTML = `<p class="text-danger">Error: ${escapeHtml(data.whois_info.message || 'Could not retrieve WHOIS information.')}</p>`;
                 }
                 scanResultsDiv.appendChild(card);
            }

            // --- Common Vulnerability Analysis --- 
            if (data.vulnerability_scan) {
                 const { card, cardBody } = createResultCard('Page Analysis', 'fas fa-bug');
                 if(data.vulnerability_scan.status === 'success') {
                    if(data.vulnerability_scan.vulnerabilities && data.vulnerability_scan.vulnerabilities.length > 0) {
                        cardBody.innerHTML = `<div class="vulnerabilities">
                        ${data.vulnerability_scan.vulnerabilities.map(vuln => `
                                <div class="vulnerability-item issue-item ${vuln.severity.toLowerCase()}">
                                    <span class="severity-badge">${escapeHtml(vuln.severity)}</span>
                                    <strong>${escapeHtml(vuln.type)}</strong>
                                    <p>${escapeHtml(vuln.description)}</p>
                                    ${vuln.element ? `<pre><code>${escapeHtml(vuln.element)}</code></pre>` : ''}
                            </div>
                        `).join('')}
                        </div>`;
                     } else {
                         cardBody.innerHTML = `<p><i class="fas fa-check-circle text-success"></i> No common page vulnerabilities found (excluding CSRF).</p>`;
                     }
                 } else {
                     cardBody.innerHTML = `<p class="text-danger">Error: ${escapeHtml(data.vulnerability_scan.message || 'Could not perform vulnerability analysis.')}</p>`;
                 }
                 scanResultsDiv.appendChild(card);
            }

            // --- CSRF Analysis --- 
            if (data.csrf_scan) {
                 const { card, cardBody } = createResultCard('CSRF Protection Analysis', 'fas fa-shield-virus');
                 if(data.csrf_scan.status === 'success') {
                    if(data.csrf_scan.vulnerabilities && data.csrf_scan.vulnerabilities.length > 0) {
                        cardBody.innerHTML = `<div class="vulnerabilities">
                            ${data.csrf_scan.vulnerabilities.map(vuln => `
                                <div class="vulnerability-item issue-item ${vuln.severity.toLowerCase()}">
                                    <span class="severity-badge">${escapeHtml(vuln.severity)}</span>
                                    <strong>${escapeHtml(vuln.type)}</strong>
                                    <p>${escapeHtml(vuln.description)}</p>
                                    ${vuln.element ? `<pre><code>${escapeHtml(vuln.element)}</code></pre>` : ''}
                    </div>
                            `).join('')}
                        </div>`;
                     } else {
                         cardBody.innerHTML = `<p><i class="fas fa-check-circle text-success"></i> No POST forms found missing potential CSRF tokens.</p>`;
                     }
                 } else {
                     cardBody.innerHTML = `<p class="text-danger">Error: ${escapeHtml(data.csrf_scan.message || 'Could not perform CSRF analysis.')}</p>`;
                 }
                 scanResultsDiv.appendChild(card);
            }

            // --- SQL Injection Analysis --- 
            if (data.sql_injection_scan) {
                 const { card, cardBody } = createResultCard('SQL Injection Analysis', 'fas fa-database');
                  if (data.sql_injection_scan.status === 'success') {
                    const isVuln = data.sql_injection_scan.url_vulnerable || data.sql_injection_scan.form_vulnerable;
                    let sqlContent = `
                        <div class="${isVuln ? 'sql-vulnerability' : 'sql-safe'}">
                            <p><strong>Overall Status:</strong> ${isVuln ? '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Potentially Vulnerable</span>' : '<span class="text-success"><i class="fas fa-check-circle"></i> Seems Safe</span>'}</p>
                            <p><small><strong>URL Parameters Tested:</strong> ${data.sql_injection_scan.url_vulnerable ? 'Yes' : 'No'}</small></p>
                            ${data.sql_injection_scan.url_vulnerable_params && data.sql_injection_scan.url_vulnerable_params.length > 0 ? `
                                <p><small><strong>Vulnerable URL Parameters:</strong> ${escapeHtml(data.sql_injection_scan.url_vulnerable_params.join(', '))}</small></p>
                        ` : ''}
                            <p><small><strong>Forms Tested:</strong> ${data.sql_injection_scan.form_vulnerable ? 'Yes' : 'No'}</small></p>
                            ${data.sql_injection_scan.vulnerable_forms && data.sql_injection_scan.vulnerable_forms.length > 0 ? `
                                <p><small><strong>Potentially Vulnerable Forms (Actions):</strong> ${escapeHtml(data.sql_injection_scan.vulnerable_forms.join(', '))}</small></p>
                             ` : ''}
                        </div>`;

                    if (data.sql_injection_scan.details && data.sql_injection_scan.details.length > 0) {
                        sqlContent += `
                            <div class="sql-details mt-3">
                                <h5><i class="fas fa-list-ul"></i> Detection Details:</h5>
                                ${data.sql_injection_scan.details.map(detail => `
                                    <div class="sql-detail-item">
                                        <span class="sql-detail-type"><i class="fas fa-cog"></i> ${escapeHtml(detail.type)}</span><br>
                                        ${detail.parameter ? `Parameter: <strong>${escapeHtml(detail.parameter)}</strong><br>` : ''}
                                        ${detail.field ? `Form Field: <strong>${escapeHtml(detail.field)}</strong><br>` : ''}
                                        ${detail.form ? `Form Action: <strong>${escapeHtml(detail.form)}</strong><br>` : ''}
                                        Payload Used: <code class="sql-detail-payload">${escapeHtml(detail.payload)}</code>
                                        ${detail.message ? `<p class="text-danger mt-1"><small>Error during test: ${escapeHtml(detail.message)}</small></p>` : ''}
                                    </div>
                                `).join('')}
                    </div>
                `;
                    }
                    cardBody.innerHTML = sqlContent;
                 } else {
                      cardBody.innerHTML = `<p class="text-danger">Error: ${escapeHtml(data.sql_injection_scan.message || 'Could not perform SQL injection analysis.')}</p>`;
                 }
                 scanResultsDiv.appendChild(card);
            }

            // --- XSS Analysis --- 
            if (data.xss_scan) {
                 const { card, cardBody } = createResultCard('Cross-Site Scripting (XSS) Analysis', 'fas fa-code');
                  if (data.xss_scan.status === 'success') {
                    const isVuln = data.xss_scan.vulnerable;
                    let xssContent = `
                        <div class="${isVuln ? 'sql-vulnerability' : 'sql-safe'}">
                            <p><strong>Overall Status:</strong> ${isVuln ? '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Potentially Vulnerable</span>' : '<span class="text-success"><i class="fas fa-check-circle"></i> Seems Safe</span>'}</p>
                            <p><small><strong>URL Parameters Vulnerable:</strong> ${data.xss_scan.vulnerable_params && data.xss_scan.vulnerable_params.length > 0 ? 'Yes' : 'No'}</small></p>
                            <p><small><strong>Forms Vulnerable:</strong> ${data.xss_scan.vulnerable_forms && data.xss_scan.vulnerable_forms.length > 0 ? 'Yes' : 'No'}</small></p>
                        </div>`;

                    if (data.xss_scan.details && data.xss_scan.details.length > 0) {
                        xssContent += `
                            <div class="sql-details mt-3">
                                <h5><i class="fas fa-list-ul"></i> Detection Details:</h5>
                                ${data.xss_scan.details.map(detail => `
                                    <div class="sql-detail-item">
                                        <span class="sql-detail-type"><i class="fas fa-cog"></i> ${escapeHtml(detail.type)}</span><br>
                                        ${detail.parameter ? `Parameter: <strong>${escapeHtml(detail.parameter)}</strong><br>` : ''}
                                        ${detail.field ? `Form Field: <strong>${escapeHtml(detail.field)}</strong><br>` : ''}
                                        ${detail.form ? `Form Action: <strong>${escapeHtml(detail.form)}</strong><br>` : ''}
                                        Payload Used: <code class="sql-detail-payload">${escapeHtml(detail.payload)}</code>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    cardBody.innerHTML = xssContent;
                 } else {
                      cardBody.innerHTML = `<p class="text-danger">Error: ${escapeHtml(data.xss_scan.message || 'Could not perform XSS analysis.')}</p>`;
                 }
                 scanResultsDiv.appendChild(card);
            }

            // --- Discovery Files Analysis (robots.txt, sitemap.xml) --- 
            if (data.discovery_scan) {
                 const { card, cardBody } = createResultCard('Discovery Files (robots.txt, sitemap.xml)', 'fas fa-file-alt');
                 let discoveryContent = '';

                 // Robots.txt info
                 discoveryContent += '<h6>robots.txt Analysis</h6>';
                 if (data.discovery_scan.robots.status === 'found') {
                     discoveryContent += '<p><i class="fas fa-check-circle text-success"></i> Found robots.txt</p>';
                     if (data.discovery_scan.robots.disallowed.length > 0) {
                         discoveryContent += '<p><strong>Disallowed Paths (for *):</strong></p><ul>';
                         data.discovery_scan.robots.disallowed.slice(0, 10).forEach(path => { // Limit display
                            discoveryContent += `<li><code>${escapeHtml(path)}</code></li>`;
                         });
                         if (data.discovery_scan.robots.disallowed.length > 10) discoveryContent += '<li>...and more</li>';
                         discoveryContent += '</ul>';
                     } else {
                         discoveryContent += '<p class="text-muted"><small>No significant Disallow entries found for `*` User-Agent.</small></p>';
                     }
                     if (data.discovery_scan.robots.sitemaps.length > 0) {
                         discoveryContent += '<p><strong>Sitemaps Declared:</strong></p><ul>';
                         data.discovery_scan.robots.sitemaps.forEach(sitemap => {
                            discoveryContent += `<li><code>${escapeHtml(sitemap)}</code></li>`;
                         });
                         discoveryContent += '</ul>';
                     }
                     // Optionally add button to show raw robots.txt

                 } else if (data.discovery_scan.robots.status === 'not_found') {
                     discoveryContent += '<p><i class="fas fa-times-circle text-muted"></i> robots.txt not found.</p>';
                 } else { // Error
                     discoveryContent += `<p><i class="fas fa-exclamation-triangle text-danger"></i> Error fetching robots.txt: ${escapeHtml(data.discovery_scan.robots.error || 'Unknown error')}</p>`;
                 }

                 // Sitemap.xml info
                 discoveryContent += '<h6 class="mt-4">sitemap.xml Analysis</h6>';
                 if (data.discovery_scan.sitemap.status === 'found') {
                     discoveryContent += '<p><i class="fas fa-check-circle text-success"></i> Found and parsed sitemap(s).</p>';
                     if (data.discovery_scan.sitemap.urls.length > 0) {
                         discoveryContent += `<p><strong>URLs Found (${data.discovery_scan.sitemap.urls.length}):</strong></p><ul style="max-height: 200px; overflow-y: auto; padding-left: 20px; border: 1px solid var(--border-color); border-radius: 4px;">`;
                         data.discovery_scan.sitemap.urls.slice(0, 50).forEach(url => { // Limit display
                            discoveryContent += `<li><small><code>${escapeHtml(url)}</code></small></li>`;
                         });
                         if (data.discovery_scan.sitemap.urls.length > 50) discoveryContent += '<li>...and more</li>';
                         discoveryContent += '</ul>';
                    } else {
                         discoveryContent += '<p class="text-muted"><small>No URLs found within the sitemap(s).</small></p>';
                     }
                 } else if (data.discovery_scan.sitemap.status === 'not_found') {
                     discoveryContent += '<p><i class="fas fa-times-circle text-muted"></i> sitemap.xml (or sitemaps from robots.txt) not found.</p>';
                 } else { // Error or Parse Error
                     discoveryContent += `<p><i class="fas fa-exclamation-triangle text-danger"></i> Error processing sitemap: ${escapeHtml(data.discovery_scan.sitemap.error || 'Unknown error')}</p>`;
                 }

                 cardBody.innerHTML = discoveryContent;
                 scanResultsDiv.appendChild(card);
            }
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') {
                 console.warn("escapeHtml received non-string input:", unsafe);
                 return unsafe;
            }
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function toggleRawWhois(button) {
            const container = button.closest('.raw-whois-container');
            const dataDiv = container.querySelector('.raw-whois-data');
            const icon = button.querySelector('i');
            
            if (dataDiv.style.display === 'none') {
                dataDiv.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                 button.classList.remove('btn-outline-secondary');
                 button.classList.add('btn-secondary');
            } else {
                dataDiv.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                 button.classList.remove('btn-secondary');
                 button.classList.add('btn-outline-secondary');
            }
        }

        // Select/Deselect All Checkbox Logic
        const selectAllCheckbox = document.getElementById('selectAllScans');
        const scanCheckboxes = document.querySelectorAll('#scanForm input[type=checkbox]:not(#selectAllScans)');
        selectAllCheckbox.addEventListener('change', function() {
            scanCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });
        scanCheckboxes.forEach(checkbox => {
             checkbox.addEventListener('change', function() {
                 if (!checkbox.checked) {
                     selectAllCheckbox.checked = false;
                 }
                 // Check if all are checked now
                 if (Array.from(scanCheckboxes).every(cb => cb.checked)) {
                     selectAllCheckbox.checked = true;
                 }
             });
        });
    </script>
</body>
</html> 